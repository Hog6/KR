<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f6fa; margin: 0; }
        .tabs { display: flex; background: #2c3e50; }
        .tab { padding: 16px 24px; color: #fff; cursor: pointer; transition: 0.2s; border: none; background: none; font-size: 16px;}
        .tab.active, .tab:hover { background: #34495e; }
        .tab-content { padding: 32px; background: #fff; border-radius: 0 0 8px 8px; margin: 0 16px 16px 16px; box-shadow: 0 2px 8px #0001;}
        h2 { color: #2c3e50; }
        table { border-collapse: collapse; width: 100%; margin-top: 12px; background: #fafbfc;}
        th, td { border: 1px solid #d1d5db; padding: 8px 12px; text-align: left;}
        th { background: #eaeaea;}
        tr:nth-child(even) { background: #f4f6fa;}
        input, select, button { padding: 8px; margin: 4px; border-radius: 4px; border: 1px solid #bbb;}
        button { background: #2c3e50; color: #fff; border: none; cursor: pointer;}
        button:hover { background: #34495e;}
        .form-row { display: flex; gap: 8px; margin-bottom: 8px;}
        .actions { display: flex; gap: 8px;}
        .photo { border-radius: 50%; width: 120px; margin-bottom: 16px;}
        @media (max-width: 700px) {
            .tab-content { padding: 8px; }
            .form-row { flex-direction: column; }
        }
        .subject-input { width: 80px; }
        .chart-container { margin-top: 20px; }
        .chart-row { display: flex; flex-wrap: wrap; gap: 20px; }
        .chart-wrapper { flex: 1; min-width: 300px; }
    </style>
</head>
<body>
    <div class="tabs">
        <button class="tab active" onclick="showTab(0)">–ó–∞–≥—Ä—É–∑–∫–∞</button>
        <button class="tab" onclick="showTab(1)">–ñ—É—Ä–Ω–∞–ª</button>
        <button class="tab" onclick="showTab(2)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü–∞)</button>
        <button class="tab" onclick="showTab(3)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≥—Ä–∞—Ñ–∏–∫–∏)</button>
        <button class="tab" onclick="showTab(4)">–ü–æ–º–æ—â—å</button>
        <button class="tab" onclick="showTab(5)">–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</button>
    </div>
    <div id="tab-0" class="tab-content">
        <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞</h2>
        <input type="file" id="fileInput" accept=".csv,.txt,.xlsx">
        <button onclick="clearTable()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <div id="uploadTable"></div>
    </div>
    <div id="tab-1" class="tab-content" style="display:none">
        <h2>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</h2>
        <div class="form-row">
            <input type="text" id="fio" placeholder="–§–ò–û">
            <input type="text" id="class" placeholder="–ö–ª–∞—Å—Å">
            <input type="number" class="subject-input" id="informatics" placeholder="–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞" min="2" max="5">
            <input type="number" class="subject-input" id="physics" placeholder="–§–∏–∑–∏–∫–∞" min="2" max="5">
            <input type="number" class="subject-input" id="math" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" min="2" max="5">
            <input type="number" class="subject-input" id="literature" placeholder="–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞" min="2" max="5">
            <input type="number" class="subject-input" id="music" placeholder="–ú—É–∑—ã–∫–∞" min="2" max="5">
            <button onclick="addOrUpdate()">–î–æ–±–∞–≤–∏—Ç—å/–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div id="editInfo"></div>
        <div id="journalTable"></div>
        <button onclick="saveToCSV()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ CSV</button>
        <button onclick="saveToTXT()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ TXT</button>
        <button onclick="saveToXLSX()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ XLSX</button>
    </div>
    <div id="tab-2" class="tab-content" style="display:none">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü–∞)</h2>
        <div id="statTable"></div>
    </div>
    <div id="tab-3" class="tab-content" style="display:none">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≥—Ä–∞—Ñ–∏–∫–∏)</h2>
        <div class="chart-row">
            <div class="chart-wrapper">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º (–≤—Å–µ –∫–ª–∞—Å—Å—ã)</h3>
                <canvas id="statChart" height="200"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∞—Å—Å–∞–º</h3>
                <select id="classSelect" onchange="renderClassChart(this.value)" style="width: 100%; margin-bottom: 10px;">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
                </select>
                <canvas id="classChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div id="tab-4" class="tab-content" style="display:none">
        <h2>–ü–æ–º–æ—â—å</h2>
        <ul>
            <li><b>–ó–∞–≥—Ä—É–∑–∫–∞:</b> –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –æ—Ü–µ–Ω–∫–∞–º–∏ (.csv, .txt, .xlsx). –¢–∞–±–ª–∏—Ü–∞ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–µ. –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–æ–ª–±—Ü—ã: –§–ò–û, –ö–ª–∞—Å—Å, –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞, –§–∏–∑–∏–∫–∞, –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞, –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞, –ú—É–∑—ã–∫–∞.</li>
            <li><b>–ñ—É—Ä–Ω–∞–ª:</b> –î–æ–±–∞–≤–ª—è–π—Ç–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏–ª–∏ —É–¥–∞–ª—è–π—Ç–µ –æ—Ü–µ–Ω–∫–∏. –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∂—É—Ä–Ω–∞–ª –≤ CSV.</li>
            <li><b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü–∞):</b> –°–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–ª–∞—Å—Å–∞–º –∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º.</li>
            <li><b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≥—Ä–∞—Ñ–∏–∫–∏):</b> –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –æ—Ü–µ–Ω–∫–∞–º.</li>
            <li><b>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ:</b> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–µ.</li>
        </ul>
    </div>
    <div id="tab-5" class="tab-content" style="display:none">
        <h2>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</h2>
        <img src="https://sun9-51.userapi.com/s/v1/ig2/Wn7QtIwqK0fBZv8vlt1Z0jauIvcuXT2RZErSslf-dG8n8GoVtlkKNbDM0bA264lyCoN_y2uBgIASRgOUWE1181LP.jpg?size=400x400&quality=95&crop=297,439,1356,1356&ava=1" class="photo" alt="–§–æ—Ç–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞">
        <p><b>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:</b> –°–æ–ª–µ–µ–≤–∞ –ü–æ–ª–∏–Ω–∞ –õ–µ–æ–Ω–∏–¥–æ–≤–Ω–∞</p>
        <p><b>Email:</b> <a href="mailto:psoleeva@mail.ru">psoleeva@mail.ru</a></p>
        <p><b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> +7 907 666 98 09</p>
    </div>
    <script>
        function showTab(idx) {
            document.querySelectorAll('.tab-content').forEach((el, i) => el.style.display = i === idx ? '' : 'none');
            document.querySelectorAll('.tab').forEach((el, i) => el.classList.toggle('active', i === idx));
            if(idx === 1) renderJournal();
            if(idx === 2) renderStatTable();
            if(idx === 3) {
                renderStatChart();
                fillClassSelect();
            }
            if(idx === 4) renderStatChart();
        }

        // –î–∞–Ω–Ω—ã–µ –∂—É—Ä–Ω–∞–ª–∞
        let journal = [];
        let editIndex = null;
        const subjects = ["–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", "–§–∏–∑–∏–∫–∞", "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", "–ú—É–∑—ã–∫–∞"];
        const requiredHeaders = ["–§–ò–û", "–ö–ª–∞—Å—Å", ...subjects];

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        document.getElementById('fileInput').addEventListener('change', function(e) {
            let file = e.target.files[0];
            if(!file) return;
            let ext = file.name.split('.').pop().toLowerCase();
            if(['csv','txt'].includes(ext)) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    let text = e.target.result;
                    let rows = text.split(/\r?\n/).filter(Boolean).map(row => row.split(/[;,]/));
                    processRows(rows);
                };
                reader.readAsText(file);
            } else if(ext === 'xlsx') {
                let reader = new FileReader();
                reader.onload = function(e) {
                    let data = new Uint8Array(e.target.result);
                    let workbook = XLSX.read(data, {type: 'array'});
                    let sheet = workbook.Sheets[workbook.SheetNames[0]];
                    let rows = XLSX.utils.sheet_to_json(sheet, {header:1});
                    processRows(rows);
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .csv, .txt, .xlsx');
            }
        });

        function processRows(rows) {
            if (rows.length === 0) {
                alert('–§–∞–π–ª –ø—É—Å—Ç–æ–π');
                return;
            }
            const headers = rows[0].map(h => h.trim());
            const missing = requiredHeaders.filter(h => !headers.includes(h));
            if (missing.length > 0) {
                alert('–í —Ñ–∞–π–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–ª–æ–Ω–∫–∏: ' + missing.join(', '));
                return;
            }
            // –ò–Ω–¥–µ–∫—Å—ã
            let idx = {};
            requiredHeaders.forEach(h => { idx[h] = headers.indexOf(h); });
            let loaded = [];
            for(let i=1; i<rows.length; ++i) {
                let r = rows[i];
                if(r.length < headers.length) continue;
                let entry = {
                    fio: r[idx["–§–ò–û"]],
                    class: r[idx["–ö–ª–∞—Å—Å"]],
                };
                subjects.forEach(s => entry[s] = parseInt(r[idx[s]]));
                loaded.push(entry);
            }
            journal = loaded;
            renderUploadTable();
            renderJournal();
        }

        function renderUploadTable() {
            let html = '<table><tr><th>–§–ò–û</th><th>–ö–ª–∞—Å—Å</th>';
            subjects.forEach(s => html += `<th>${s}</th>`);
            html += '</tr>';
            for(let row of journal)
                html += `<tr><td>${row.fio}</td><td>${row.class}</td>${subjects.map(s=>`<td>${row[s]}</td>`).join('')}</tr>`;
            html += '</table>';
            document.getElementById('uploadTable').innerHTML = html;
        }

        function clearTable() {
            journal = [];
            renderUploadTable();
            renderJournal();
        }

        // –ñ—É—Ä–Ω–∞–ª: –¥–æ–±–∞–≤–∏—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        function addOrUpdate() {
            let fio = document.getElementById('fio').value.trim();
            let cls = document.getElementById('class').value.trim();
            let entry = {fio, class: cls};
            let valid = fio && cls;
            subjects.forEach(s => {
                let val = parseInt(document.getElementById(subjectToId(s)).value);
                entry[s] = val;
                if(isNaN(val) || val<2 || val>5) valid = false;
            });
            if(!valid) {
                alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞!');
                return;
            }
            if(editIndex !== null) {
                journal[editIndex] = entry;
                editIndex = null;
                document.getElementById('editInfo').innerHTML = '';
            } else {
                journal.push(entry);
            }
            document.getElementById('fio').value = '';
            document.getElementById('class').value = '';
            subjects.forEach(s=>document.getElementById(subjectToId(s)).value='');
            renderJournal();
            renderUploadTable();
        }
        function subjectToId(s) {
            return {
                "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞":"informatics",
                "–§–∏–∑–∏–∫–∞":"physics",
                "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞":"math",
                "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞":"literature",
                "–ú—É–∑—ã–∫–∞":"music"
            }[s];
        }

        function renderJournal() {
            let html = '<table><tr><th>–§–ò–û</th><th>–ö–ª–∞—Å—Å</th>';
            subjects.forEach(s => html += `<th>${s}</th>`);
            html += '<th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>';
            journal.forEach((row, i) => {
                html += `<tr>
                    <td>${row.fio}</td>
                    <td>${row.class}</td>
                    ${subjects.map(s=>`<td>${row[s]}</td>`).join('')}
                    <td class="actions">
                        <button onclick="editRow(${i})">‚úé</button>
                        <button onclick="deleteRow(${i})">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            html += '</table>';
            document.getElementById('journalTable').innerHTML = html;
        }

        function editRow(i) {
            let row = journal[i];
            document.getElementById('fio').value = row.fio;
            document.getElementById('class').value = row.class;
            subjects.forEach(s=>document.getElementById(subjectToId(s)).value=row[s]);
            editIndex = i;
            document.getElementById('editInfo').innerHTML = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏. –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å/–°–æ—Ö—Ä–∞–Ω–∏—Ç—å".';
        }

        function deleteRow(i) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
                journal.splice(i,1);
                renderJournal();
                renderUploadTable();
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ CSV
        function saveToCSV() {
            if (!journal || !journal.length) return alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
            const headers = Object.keys(journal[0]);
            const rows = journal.map(obj => headers.map(h => obj[h] ?? '').join(';'));
            const csv = [headers.join(';'), ...rows].join('\r\n');
            downloadFile(csv, 'journal.csv', 'text/csv');
        }

        function saveToTXT() {
            if (!journal || !journal.length) return alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
            const headers = Object.keys(journal[0]);
            const rows = journal.map(obj => headers.map(h => obj[h] ?? '').join(';'));
            const txt = [headers.join(';'), ...rows].join('\r\n');
            downloadFile(txt, 'journal.txt', 'text/plain');
        }

        function saveToXLSX() {
            if (!journal || !journal.length) return alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!");
            const ws = XLSX.utils.json_to_sheet(journal);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "–ñ—É—Ä–Ω–∞–ª");
            const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
            const blob = new Blob([wbout], {type: "application/octet-stream"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "journal.xlsx";
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        function downloadFile(data, filename, mime) {
            const blob = new Blob([data], {type: mime});
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        function renderStatTable() {
            // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏ –ø—Ä–µ–¥–º–µ—Ç–∞
            let byClass = {};
            journal.forEach(r=>{
                if(!byClass[r.class]) byClass[r.class]={};
                subjects.forEach(s=>{
                    if(!byClass[r.class][s]) byClass[r.class][s]=[];
                    byClass[r.class][s].push(r[s]);
                });
            });
            let html = '<h3>–ü–æ –∫–ª–∞—Å—Å–∞–º –∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h3><table><tr><th>–ö–ª–∞—Å—Å</th><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–°—Ä–µ–¥–Ω—è—è</th><th>–ú–µ–¥–∏–∞–Ω–∞</th><th>–ö–æ–ª-–≤–æ</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>';
            for(let cls in byClass) {
                for(let s of subjects) {
                    let grades = byClass[cls][s]||[];
                    html += `<tr>
                        <td>${cls}</td>
                        <td>${s}</td>
                        <td>${avg(grades).toFixed(2)}</td>
                        <td>${median(grades)}</td>
                        <td>${grades.length}</td>
                        <td>${count(grades,2)} (${perc(grades,2)}%)</td>
                        <td>${count(grades,3)} (${perc(grades,3)}%)</td>
                        <td>${count(grades,4)} (${perc(grades,4)}%)</td>
                        <td>${count(grades,5)} (${perc(grades,5)}%)</td>
                    </tr>`;
                }
            }
            html += '</table>';

            // –°—Ä–µ–¥–∏ –≤—Å–µ—Ö —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
            let bySubject = {};
            subjects.forEach(s=>bySubject[s]=[]);
            journal.forEach(r=>{
                subjects.forEach(s=>bySubject[s].push(r[s]));
            });
            html += '<h3>–ü–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º (–≤—Å–µ –∫–ª–∞—Å—Å—ã)</h3><table><tr><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–°—Ä–µ–¥–Ω—è—è</th><th>–ú–µ–¥–∏–∞–Ω–∞</th><th>–ö–æ–ª-–≤–æ</th><th>2</th><th>3</th><th>4</th><th>5</th></tr>';
            for(let s of subjects) {
                let grades = bySubject[s];
                html += `<tr>
                    <td>${s}</td>
                    <td>${avg(grades).toFixed(2)}</td>
                    <td>${median(grades)}</td>
                    <td>${grades.length}</td>
                    <td>${count(grades,2)} (${perc(grades,2)}%)</td>
                    <td>${count(grades,3)} (${perc(grades,3)}%)</td>
                    <td>${count(grades,4)} (${perc(grades,4)}%)</td>
                    <td>${count(grades,5)} (${perc(grades,5)}%)</td>
                </tr>`;
            }
            html += '</table>';
            document.getElementById('statTable').innerHTML = html;
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –≥—Ä–∞—Ñ–∏–∫–∏
        let chart;
        let classChart;
        
        function fillClassSelect() {
            const select = document.getElementById('classSelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>';
            
            // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã
            const classes = [...new Set(journal.map(item => item.class))].sort();
            
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                select.appendChild(option);
            });
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–ª–∞—Å—Å—ã, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (classes.length > 0) {
                select.value = classes[0];
                renderClassChart(classes[0]);
            }
        }
        
        function renderClassChart(selectedClass) {
            if (!selectedClass) return;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫–ª–∞—Å—Å—É
            const classData = journal.filter(item => item.class === selectedClass);
            
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            const gradeCounts = {
                '2': subjects.map(subj => countGrades(classData, subj, 2)),
                '3': subjects.map(subj => countGrades(classData, subj, 3)),
                '4': subjects.map(subj => countGrades(classData, subj, 4)),
                '5': subjects.map(subj => countGrades(classData, subj, 5))
            };
            
            const ctx = document.getElementById('classChart').getContext('2d');
            
            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (classChart) {
                classChart.destroy();
            }
            
            classChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subjects,
                    datasets: [
                        {
                            label: '–û—Ü–µ–Ω–∫–∞ 2',
                            data: gradeCounts['2'],
                            backgroundColor: '#e74c3c'
                        },
                        {
                            label: '–û—Ü–µ–Ω–∫–∞ 3',
                            data: gradeCounts['3'],
                            backgroundColor: '#f1c40f'
                        },
                        {
                            label: '–û—Ü–µ–Ω–∫–∞ 4',
                            data: gradeCounts['4'],
                            backgroundColor: '#3498db'
                        },
                        {
                            label: '–û—Ü–µ–Ω–∫–∞ 5',
                            data: gradeCounts['5'],
                            backgroundColor: '#2ecc71'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ü–µ–Ω–æ–∫ –¥–ª—è –∫–ª–∞—Å—Å–∞ ${selectedClass}`
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ü–µ–Ω–æ–∫'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '–ü—Ä–µ–¥–º–µ—Ç—ã'
                            }
                        }
                    }
                }
            });
        }
        
        function countGrades(data, subject, grade) {
            return data.filter(item => item[subject] === grade).length;
        }

        function renderStatChart() {
            // –ü–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º (–≤—Å–µ –∫–ª–∞—Å—Å—ã)
            let bySubject = {};
            subjects.forEach(s=>bySubject[s]=[]);
            journal.forEach(r=>{
                subjects.forEach(s=>bySubject[s].push(r[s]));
            });
            let labels = subjects;
            let data2 = labels.map(s => count(bySubject[s],2));
            let data3 = labels.map(s => count(bySubject[s],3));
            let data4 = labels.map(s => count(bySubject[s],4));
            let data5 = labels.map(s => count(bySubject[s],5));
            let ctx = document.getElementById('statChart').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {label:'–û—Ü–µ–Ω–∫–∞ 2', data:data2, backgroundColor:'#e74c3c'},
                        {label:'–û—Ü–µ–Ω–∫–∞ 3', data:data3, backgroundColor:'#f1c40f'},
                        {label:'–û—Ü–µ–Ω–∫–∞ 4', data:data4, backgroundColor:'#3498db'},
                        {label:'–û—Ü–µ–Ω–∫–∞ 5', data:data5, backgroundColor:'#2ecc71'},
                    ]
                },
                options: {
                    responsive:true,
                    plugins: {legend:{position:'top'}},
                    scales: {y:{beginAtZero:true, stepSize:1}}
                }
            });
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function avg(arr) { if(!arr.length) return 0; return arr.reduce((a,b)=>a+b,0)/arr.length; }
        function median(arr) {
            if(!arr.length) return 0;
            arr = arr.slice().sort((a,b)=>a-b);
            let m = Math.floor(arr.length/2);
            return arr.length%2 ? arr[m] : ((arr[m-1]+arr[m])/2).toFixed(2);
        }
        function count(arr, val) { return arr.filter(x=>x===val).length; }
        function perc(arr, val) { return arr.length ? Math.round(100*count(arr,val)/arr.length) : 0; }
    </script>
</body>
</html>